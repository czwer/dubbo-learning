### 环境准备：

环境搭建时相关版本如下：

dubbo的版本为：dubbo-3.3.5-add-more-logging（基于tag:dubbo-3.3.5日志增强版本）

JDK版本：17

maven版本：3.9.11

gradle版本：8.14.3

spring版本：v6.2.7-add-more-logging（基于tag:v6.2.7日志增强版本）

zookeeper版本：3.9.3

dubbo admin版本：0.6.0-release

### 一.ubuntu中JDK安装

（1）下载bellsoft-jdk17.0.16，选择FULL JDK（Spring源码构建时依赖该JDK，其基于OPENJDK）：https://bell-sw.com/pages/downloads/#jdk-17-lts

    https://download.bell-sw.com/java/17.0.16+12/bellsoft-jdk17.0.16+12-linux-amd64-full.tar.gz
    https://download.bell-sw.com/java/21.0.8+12/bellsoft-jdk21.0.8+12-linux-amd64-full.tar.gz

（2）ubuntu中JDK多版本下使用：

（2.1）克隆jenv：git clone https://github.com/jenv/jenv.git ~/.jenv

（2.2）配置环境：

    echo 'export PATH="$HOME/.jenv/bin:$PATH"' >> ~/.bashrc
    echo 'eval "$(jenv init -)"' >> ~/.bashrc

（2.3）使.bashrc修改生效：source ~/.bashrc

（2.4）jenv加入jdk的管理：

    tar -xzvf bellsoft-jdk17.0.16+12-linux-amd64-full.tar.gz
    tar -xzvf bellsoft-jdk21.0.8+12-linux-amd64-full.tar.gz
    jenv add /usr/lib/jvm/jdk-17.0.16-full
    jenv add /usr/lib/jvm/jdk-21.0.8-full
    备注：jdk21在spring源码构建时会用到

（2.5）切换JDK版本：jenv global 17


### 二.ubuntu中maven安装（dubbo使用）

（1）maven下载地址：https://dlcdn.apache.org/maven/maven-3/3.9.11/binaries/apache-maven-3.9.11-bin.zip

    修改apache-maven-3.9.11/conf/settings.xml,添加阿里云镜像源，以提高构建速度：
    <mirror>
    	<id>nexus-aliyun</id>
    	<mirrorOf>central</mirrorOf>
    	<name>Nexus aliyun</name>
    	<url>https://maven.aliyun.com/nexus/content/groups/public</url>
    </mirror>


（2）ubuntu中maven多版本下使用：

（2.1）maven加入update-alternatives的管理：sudo update-alternatives --install /usr/bin/mvn mvn /path/to/your/apache-maven-3.9.11/bin/mvn 3911

（2.2）选择maven版本，输入选择这一列的编号：sudo update-alternatives --config mvn

### 三.ubuntu中安装gradle

（1）安装gradle

（1.1）方式一：通过SDKMAN，直接安装：
    
    curl -s "https://get.sdkman.io" | bash
    source "$HOME/.sdkman/bin/sdkman-init.sh"
    sdk list gradle
    sdk install gradle 8.14

（1.2）方式二：通过阿里云镜像下载，https://mirrors.aliyun.com/gradle/distributions/v8.14.0/gradle-8.14-all.zip

    sdk install gradle 8.14 /path/to/your/gradle-8.14-all.zip

（2）配置阿里云镜像，以加速访问：
    
    创建：~/.gradle/init.d/aliyun-mirror.init.gradle.kts，内容如下：
    allprojects {
        buildscript {
            repositories {
                maven { url = uri("https://maven.aliyun.com/repository/public") }
                maven { url = uri("https://maven.aliyun.com/repository/spring") }
                maven { url = uri("https://maven.aliyun.com/repository/gradle-plugin") }
                maven { url = uri("https://maven.aliyun.com/repository/apache-snapshots") }
                maven { url = uri("https://maven.aliyun.com/repository/google") }
                // 保留官方仓库
                mavenCentral()
                gradlePluginPortal()
            }
        }
        repositories {
            maven { url = uri("https://maven.aliyun.com/repository/public") }
            maven { url = uri("https://maven.aliyun.com/repository/spring") }
            maven { url = uri("https://maven.aliyun.com/repository/gradle-plugin") }
            maven { url = uri("https://maven.aliyun.com/repository/apache-snapshots") }
            maven { url = uri("https://maven.aliyun.com/repository/google") }
            mavenCentral()
        }
    }


### 四.IntelliJ IDEA Community Edition下载安装

    下载地址：https://www.jetbrains.com/idea/download/?section=linux
    安装完成后修改配置：
        Gradle user home：~/.gradle
        Build and run using : IntelliJ IDEA
        Run tests using : IntelliJ IDEA
        Distribution：Wrapper
        Gradle JVM：BellSoft Liberica 17.0.16

### 五.spring：日志增强版本，以更好观察dubbo启动和运行过程

（1）在spring官方fork到个人仓库：https://github.com/spring-projects/spring-framework

（2）git clone git@github.com:czwer/spring-framework.git

（3）切到目标tag：git checkout v6.2.7

（4）创建日志增强分支：git checkout -b v6.2.7-add-more-logging

（5）配置gradle：

    cp ~/.sdkman/tmp/gradle-8.14-all.zip /usr/lib/gradle
    修改文件：gradle/wrapper/gradle-wrapper.properties：
        修改该行,指定本地gradle位置：distributionUrl=file:///usr/lib/gradle/gradle-8.14-all.zip
    修改文件：gradle.properties中：
        修改代码构建的版本号：version=6.2.7-add-more-logging
        添加该行，指定JDK安装路径：org.gradle.java.installations.paths=/usr/lib/jvm/jdk-17.0.16-full,/usr/lib/jvm/jdk-21.0.8-full
    修改文件：build.gradle
        声明编码：
            tasks.withType(JavaCompile) {
                options.encoding = 'UTF-8'
            }
        直接排除不需要构建的模块：
            def excludedProjects = [':framework-docs', ':integration-tests', ':spring-core-test']
            gradle.projectsLoaded {
                subprojects.findAll { excludedProjects.forEach {excludedProject->it.name.contains(excludedProject)} }.each {
                    it.tasks.all { task ->
                        task.enabled = false // 禁用该项目的所有任务
                    }
                }
            }

（6）预编译 spring-oxm 模块（必须步骤）：

    ./gradlew :spring-oxm:compileTestJava

（7）完整编译：
    
    方案1：编译并发布到本机.m2方便其它项目使用
        ./gradlew -x test -x javadoc publishToMavenLocal
    方案2：并行编译（加快速度）
        ./gradlew -x test -x javadoc publishToMavenLocal --parallel

    编译生成的jar在各个模块中：模块名/build/libs/模块名-6.2.7-add-more-logging.jar

（8）部分编译并发布到本机：

    ./gradlew :spring-core:publishToMavenLocal -x test -x javadoc --parallel

### 六.spring-boot：日志增强版本，以更好观察dubbo启动和运行过程

（1）在spring-boot官方fork到个人仓库：https://github.com/spring-projects/spring-boot

（2）git clone git@github.com:czwer/spring-boot.git

（3）切到目标tag：git checkout v3.5.0

（4）创建日志增强分支：git checkout -b v3.5.0-add-more-logging

    修改原来“3.5.0”版本号为：“”

（5）配置gradle：

    修改文件：gradle/wrapper/gradle-wrapper.properties：
        修改该行,指定本地gradle位置：distributionUrl=file:///usr/lib/gradle/gradle-8.14-all.zip
    修改文件：gradle.properties中：
        修改代码构建的版本号：version=3.5.0-add-more-logging
        修改spring的版本号：springFrameworkVersion=6.2.7-add-more-logging
        添加该行，指定JDK安装路径：org.gradle.java.installations.paths=/usr/lib/jvm/jdk-17.0.16-full,/usr/lib/jvm/jdk-21.0.8-full
    修改文件：buildSrc/build.gradle
        添加该行，引用本地.m2下依赖，repositories中第一个行：mavenLocal()  // 必须放在首位
    修改文件：build.gradle
        添加该行，引用本地.m2下依赖，repositories中第一个行：mavenLocal()  // 必须放在首位
        直接排除不需要构建的模块：
        def excludedProjects = [':spring-boot-docs', ':spring-boot-system-tests', ':spring-boot-tests']
        gradle.projectsLoaded {
           subprojects.findAll { excludedProjects.forEach {excludedProject->it.name.contains(excludedProject)} }.each {
                it.tasks.all { task ->
                    task.enabled = false // 禁用该项目的所有任务
                }
            }
        }


（6）完整编译：

    ./gradlew -x test publishToMavenLocal

    编译生成的jar在各个模块中：模块名/build/libs/模块名-6.2.7-add-more-logging.jar


### 七.dubbo：日志增强版本，以更好观察duboo启动和运行过程

（1）在dubbo官方fork到个人仓库：https://github.com/apache/dubbo

（2）git clone git@github.com:czwer/dubbo.git

（3）切到目标tag：git checkout dubbo-3.3.5

（4）创建日志增强分支：git checkout -b dubbo-3.3.5-add-more-logging，新增的日志：“自定义日志---“

    修改文件：dubbo/pom.xml，dubbo-dependencies-bom/pom.xml：
        修改代码构建的版本号：3.3.5-add-more-logging
    修改文件：dubbo/pom.xml：
        修改spring版本：6.2.7-add-more-logging
        修改spring-boot版本：3.5.0-add-more-logging
    修改文件：.mvn\wrapper\maven-wrapper.properties
        #linux
        #distributionUrl=file:///usr/lib/maven/apache-maven-3.9.11-bin.zip
        #windows
        distributionUrl=file:///D:/Development/maven/apache-maven-3.9.11-bin.zip

（5）编译源码：

    跳过所有测试：
        mvn spotless:apply clean install -DskipTests
    或者跳过测试编译和执行：
        linux：
            mvn spotless:apply clean install -Dmaven.test.skip=true
        windows：
            mvn spotless:apply clean install '-Dmaven.test.skip=true'
        或分开执行
        linux：
            mvn spotless:apply
            mvn clean install -Dmaven.test.skip=true
        windows：
            mvn spotless:apply
            mvn clean install '-Dmaven.test.skip=true'
    编译指定模块：
        mvn clean compile -pl dubbo-config -Dmaven.test.skip=true

（6）构建所生成jar位置：
    
    dubbo/dubbo-distribution/dubbo-all/target/dubbo-3.3.5-add-more-logging.jar
    dubbo/dubbo-spring-boot-project/dubbo-spring-boot-starters/dubbo-spring-boot-starter/target/dubbo-spring-boot-starter-3.3.5-add-more-logging.jar
    
### 八.zookeeper安装

（1）zookeeper下载地址：https://dlcdn.apache.org/zookeeper/zookeeper-3.9.4/apache-zookeeper-3.9.4-bin.tar.gz

（2）拷贝配置：cp apache-zookeeper-3.9.4-bin/conf/zoo_sample.cfg apache-zookeeper-3.9.4-bin/conf/zoo.cfg

（3）创建数据目录和日志目录：

    mkdir apache-zookeeper-3.9.4-bin/data
    mkdir apache-zookeeper-3.9.4-bin/logs
（4）修改apache-zookeeper-3.9.3-bin/conf/zoo.cfg：

    dataDir=/path/to/your/apache-zookeeper-3.9.4-bin/data
    dataLogDir=/path/to/your/apache-zookeeper-3.9.4-bin/logs
（5）启动：

（5.1）前台启动：apache-zookeeper-3.9.3-bin/bin/zkServer.sh start-foreground

（5.2）后台启动：apache-zookeeper-3.9.3-bin/bin/zkServer.sh start

### 九.dubbo admin安装

（1）官网：https://github.com/apache/dubbo-admin

（2）dubbo admin下载：git clone https://github.com/apache/dubbo-admin.git

（2.1）切到分支：0.6.0-release

（2.2）修改dubbo-admin/dubbo-admin-server/pom.xml中zookeeper版本：3.7.2

    <groupId>org.apache.zookeeper</groupId>
    <artifactId>zookeeper</artifactId>
    <version>3.7.2</version>

（2.3）maven进行构建： mvn clean install -Dmaven.test.skip=true

（2.4）启动： java -jar dubbo-admin-server-0.6.0.jar

（3）访问地址：http://localhost:38080/#/ ，root/root

